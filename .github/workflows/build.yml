name: Build
run-name: Build with rk3566 Debian

on:
  workflow_dispatch:
    inputs:
      launchpad:
        description: use launchpad
        required: true
        default: false
        type: boolean
      version:
        description: Version tag (e.g., rc-0.0.1, beta-1.0.0, final-2.0.0)
        required: true
        default: 'rc-0.0.1'
        type: string
      product_name:
        description: Product Name (e.g., mixtile-rk3566)
        required: true
        default: 'mixtile-rk3566'
        type: string
      image_type:
        description: Image Type (RK or RAW)
        required: true
        default: 'RK'
        type: choice
        options:
          - RK
          - RAW
      system_name:
        description: System Name with version (e.g., ubuntu22.04, Debian12)
        required: true
        default: 'Debian'
        type: string
      kernel_version:
        description: Linux kernel version (e.g., linux5.10, linux6.1)
        required: true
        default: 'linux6.1'
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        platform:
          - rk3566

    env:
      PRODUCT_NAME: ${{ inputs.product_name }}
      VERSION_TAG: ${{ inputs.version }}
      IMAGE_TYPE: ${{ inputs.image_type }}
      SYSTEM_NAME: ${{ inputs.system_name }}
      KERNEL_VER: ${{ inputs.kernel_version }}

    steps:
      - name: Get more disk space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout LFS
        shell: bash
        run: git lfs fetch && git lfs checkout

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update && \
          sudo apt-get install -y \
          git git-lfs ssh make gcc libssl-dev liblz4-tool expect g++ patchelf chrpath gawk texinfo \
          diffstat software-properties-common bison flex fakeroot cmake gcc-multilib \
          g++-multilib unzip device-tree-compiler libncurses-dev python3-pip file \
          python3-pyelftools bc build-essential zlib1g-dev libbz2-dev libreadline-dev \
          libsqlite3-dev wget curl llvm libncursesw5-dev xz-utils tk-dev libxml2-dev \
          libxmlsec1-dev libffi-dev liblzma-dev uuid-dev libbluetooth-dev u-boot-tools \
          rsync libmpc-dev bsdmainutils python2 gettext qemu-user-static binfmt-support \
          live-build xxd sudo time && git lfs install
  
      - name: Enable qemu-aarch64
        shell: bash
        run: |
          sudo update-binfmts --enable qemu-aarch64

      - name : Rebuild live-build
        shell: bash
        run: |
          sudo apt-get remove live-build
          pushd /tmp && \
          git clone https://salsa.debian.org/live-team/live-build.git --depth 1 -b debian/1%20230131 && \
          cd live-build && \
          rm -rf manpages/po/ && \
          sudo make install && \
          popd

      - name: Checkout
        uses: actions/checkout@v4

      - name: Export PAT
        run: |
          echo "TOKEN=${{ secrets.GH_PAT }}" >> $GITHUB_ENV
          git config --global url."https://oauth2:${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Set build date and compose image name
        shell: bash
        run: |
          BUILD_DATE=$(date +'%y%m%d')
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
          IMAGE_NAME="${PRODUCT_NAME}-${VERSION_TAG}-${IMAGE_TYPE}-format-${SYSTEM_NAME}-${KERNEL_VER}-${BUILD_DATE}"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
          echo "Image name will be: $IMAGE_NAME"
          echo "Version tag: $VERSION_TAG"

      - name: Install repo
        shell: bash
        run: |
          mkdir -p ~/.bin && \
          sudo curl https://storage.googleapis.com/git-repo-downloads/repo -o ~/.bin/repo && \
          sudo cp ~/.bin/repo /usr/bin/repo && sudo chmod a+x /usr/bin/repo

      - name: download code
        shell: bash
        run: |
          echo y | repo init -u https://github.com/mixtile-rockchip/mixtile-rk3566-manifests \
            -b rk3566-rk3568-rkr6 \
            -m rk3566_rk3568_linux6.1_release.xml && \
          repo sync -c --no-tags --no-clone-bundle && \
          repo forall -c 'if [ -d .git ]; then echo "===> $REPO_PATH"; git lfs install --local; git lfs pull || true; fi'

      - name: Create version file in overlay
        shell: bash
        run: |
          # Create overlay directory if it doesn't exist
          mkdir -p debian/overlay/etc
          # Write version file
          echo "$VERSION_TAG" > debian/overlay/etc/version
          echo "Created /etc/version file in debian/overlay with content: $VERSION_TAG"
          # Verify the file was created
          if [ -f "debian/overlay/etc/version" ]; then
            echo "Version file content: $(cat debian/overlay/etc/version)"
          else
            echo "Warning: Failed to create version file"
            exit 1
          fi

      - name: Build image
        shell: bash
        run: |
          echo '2' > input.txt && \
          sudo ./build.sh chip < input.txt && sudo rm input.txt && \
          sudo ./build.sh all

      - name: xz image
        shell: bash
        run: |
          pushd ./output/update/Image && \
          sudo xz -4 --force --quiet --threads=0 update.img && \
          sudo mv update.img.xz "${IMAGE_NAME}.img.xz" && \
          popd
          echo "Image file renamed to: ${IMAGE_NAME}.img.xz"

      - name: Upload RK Image image
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.IMAGE_NAME }}
          path: ./output/update/Image/${{ env.IMAGE_NAME }}.img.xz
          if-no-files-found: error

      - name: Clean cache
        shell: bash
        run: sync && sudo rm -rf output && sync
